/**
 * ORQUESTADOR MAESTRO DEL SISTEMA DE ASISTENCIA
 * VERSI√ìN SIMPLIFICADA - Sin detecci√≥n de duplicados
 * 
 * La detecci√≥n de duplicados se maneja mediante regla de validaci√≥n de datos:
 * =CONTAR.SI($A:$A, A1)=1
 * 
 * ORDEN DE EJECUCI√ìN:
 * 1. Verificar protecci√≥n de edici√≥n (¬øse puede editar?)
 * 2. Validar formato de RUT (¬øes un RUT v√°lido?)
 * 3. Enviar correo electr√≥nico (solo si es v√°lido)
 */

// ============================================================================
// CONFIGURACI√ìN DEL ORQUESTADOR
// ============================================================================

const ORQUESTADOR_CONFIG = {
  COLUMNA_RUT: 1,              // Columna A
  COLUMNA_VALIDACION: 2,       // Columna B
  COLUMNA_NOMBRE: 3,           // Columna C
  COLUMNA_VALIDACION_CORREO: 8, // Columna H
  COLUMNA_CORREO: 10,          // Columna J
  COLUMNA_CODIGO: 11,          // Columna K
  COLUMNA_ASAMBLEA: 12,        // Columna L
  FILA_ENCABEZADO: 1
};

// ============================================================================
// FUNCI√ìN MAESTRA - √öNICO TRIGGER ACTIVO
// ============================================================================

/**
 * FUNCI√ìN MAESTRA que orquesta todo el sistema
 * Esta es la √öNICA funci√≥n que debe tener trigger "onEdit"
 * 
 * @param {Object} e - Objeto de evento de edici√≥n
 */
function orquestadorMaestro(e) {
  try {
    // Obtener informaci√≥n del evento
    const sheet = e.source.getActiveSheet();
    const range = e.range;
    const row = range.getRow();
    const col = range.getColumn();
    
    // Solo procesar ediciones en la columna A (RUT) y no en el encabezado
    if (col !== ORQUESTADOR_CONFIG.COLUMNA_RUT || row <= ORQUESTADOR_CONFIG.FILA_ENCABEZADO) {
      return;
    }
    
    const nuevoValor = e.value;
    const valorAnterior = e.oldValue;
    
    Logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    Logger.log("üéØ ORQUESTADOR INICIADO - Fila: " + row);
    Logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    
    // ========================================================================
    // PASO 1: VERIFICAR PROTECCI√ìN DE EDICI√ìN
    // ========================================================================
    
    if (!paso1_verificarProteccionEdicion(sheet, row, nuevoValor, valorAnterior, range)) {
      Logger.log("‚ùå BLOQUEADO: Protecci√≥n de edici√≥n activa");
      return; // DETENER TODO EL PROCESO
    }
    
    Logger.log("‚úÖ Paso 1 completado: Sin restricciones de edici√≥n");
    
    // ========================================================================
    // PASO 2: VALIDAR FORMATO DE RUT
    // ========================================================================
    
    const rutValido = paso2_validarFormatoRUT(sheet, row, nuevoValor);
    
    if (!rutValido) {
      Logger.log("‚ö†Ô∏è Paso 2: RUT NO V√ÅLIDO - No se enviar√° correo");
      return; // DETENER - No continuar si el RUT no es v√°lido
    }
    
    Logger.log("‚úÖ Paso 2 completado: RUT V√ÅLIDO");
    
    // ========================================================================
    // PASO 3: ENVIAR CORREO ELECTR√ìNICO
    // ========================================================================
    
    // Peque√±a pausa para asegurar que la validaci√≥n se escribi√≥
    Utilities.sleep(300);
    
    const correoEnviado = paso3_enviarCorreo(sheet, row);
    
    if (correoEnviado) {
      Logger.log("‚úÖ Paso 3 completado: Correo enviado exitosamente");
    } else {
      Logger.log("‚ö†Ô∏è Paso 3: No se pudo enviar correo (verificar datos)");
    }
    
    Logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    Logger.log("üéâ PROCESO COMPLETADO EXITOSAMENTE");
    Logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    
  } catch (error) {
    Logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    Logger.log("üí• ERROR EN ORQUESTADOR: " + error.toString());
    Logger.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    
    // Registrar el error en la columna de validaci√≥n de correo
    try {
      e.source.getActiveSheet()
        .getRange(e.range.getRow(), ORQUESTADOR_CONFIG.COLUMNA_VALIDACION_CORREO)
        .setValue("ERROR: " + error.toString().substring(0, 50));
    } catch (e2) {
      Logger.log("No se pudo registrar el error en la hoja");
    }
  }
}

// ============================================================================
// PASO 1: VERIFICAR PROTECCI√ìN DE EDICI√ìN
// ============================================================================

/**
 * Verifica si se puede editar el RUT (protecci√≥n contra edici√≥n de RUTs existentes)
 * 
 * @param {Sheet} sheet - La hoja de c√°lculo
 * @param {number} row - N√∫mero de fila
 * @param {string} nuevoValor - Nuevo valor ingresado
 * @param {string} valorAnterior - Valor que hab√≠a antes
 * @param {Range} range - Rango editado
 * @return {boolean} - true si se puede continuar, false si est√° bloqueado
 */
function paso1_verificarProteccionEdicion(sheet, row, nuevoValor, valorAnterior, range) {
  // Verificar si la protecci√≥n est√° activa
  if (!estaProteccionActiva()) {
    Logger.log("  üîì Protecci√≥n desactivada - permitiendo edici√≥n");
    return true;
  }
  
  // Si hay un valor anterior, significa que se est√° intentando EDITAR
  if (valorAnterior && valorAnterior !== "") {
    Logger.log("  üö´ Intento de editar RUT existente: '" + valorAnterior + "'");
    
    // Restaurar el valor anterior
    range.setValue(valorAnterior);
    
    // Mostrar alerta
    SpreadsheetApp.getUi().alert(
      "‚õî Edici√≥n Bloqueada",
      "NO SE PUEDE EDITAR: El RUT ya est√° registrado y protegido.\n\n" +
      "Para modificarlo, ejecuta la funci√≥n 'permitirEdicionRUT()' desde Apps Script.",
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    return false; // BLOQUEAR
  }
  
  return true; // PERMITIR
}

// ============================================================================
// PASO 2: VALIDAR FORMATO DE RUT
// ============================================================================

/**
 * Valida el formato del RUT chileno y escribe el resultado en columna B
 * 
 * @param {Sheet} sheet - La hoja de c√°lculo
 * @param {number} row - N√∫mero de fila
 * @param {string} nuevoValor - RUT a validar
 * @return {boolean} - true si el RUT es v√°lido, false si no
 */
function paso2_validarFormatoRUT(sheet, row, nuevoValor) {
  Logger.log("  üîç Validando formato de RUT...");
  
  let validationResult = '';
  
  // Si la celda est√° vac√≠a, limpiar validaci√≥n
  if (!nuevoValor || nuevoValor === "") {
    validationResult = '';
    sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_VALIDACION).setValue(validationResult);
    return false;
  }
  
  try {
    // Convertir a string y validar
    const rutString = String(nuevoValor).trim();
    const esValido = validateChileanRut(rutString);
    
    validationResult = esValido ? 'VALIDO' : 'NO VALIDO';
    
    Logger.log("  " + (esValido ? "‚úì" : "‚úó") + " RUT validado: " + validationResult);
    
  } catch (error) {
    validationResult = 'NO VALIDO';
    Logger.log("  ‚úó Error al validar RUT: " + error.toString());
  }
  
  // Escribir resultado en columna B
  sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_VALIDACION).setValue(validationResult);
  
  return validationResult === 'VALIDO';
}

// ============================================================================
// PASO 3: ENVIAR CORREO ELECTR√ìNICO
// ============================================================================

/**
 * Env√≠a el correo electr√≥nico con dise√±o HTML
 * Solo se ejecuta si el RUT es v√°lido
 * 
 * @param {Sheet} sheet - La hoja de c√°lculo
 * @param {number} row - N√∫mero de fila
 * @return {boolean} - true si se envi√≥ el correo, false si no
 */
function paso3_enviarCorreo(sheet, row) {
  Logger.log("  üìß Preparando env√≠o de correo...");
  
  try {
    // Obtener datos de la fila
    const rut = sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_RUT).getValue();
    const validacion = sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_VALIDACION).getValue();
    const nombre = sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_NOMBRE).getValue();
    const correo = sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_CORREO).getValue();
    const asamblea = sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_ASAMBLEA).getValue();
    
    // Verificar que el RUT sea v√°lido
    if (validacion !== 'VALIDO') {
      Logger.log("  ‚ö†Ô∏è RUT no v√°lido - no enviar correo");
      return false;
    }
    
    // Verificar que hay correo electr√≥nico
    if (!correo || correo.toString().trim() === '') {
      Logger.log("  ‚ö†Ô∏è No hay correo electr√≥nico en fila " + row);
      sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_VALIDACION_CORREO)
        .setValue('ERROR: Sin correo electr√≥nico');
      return false;
    }
    
    // Verificar/generar c√≥digo
    let codigo = sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_CODIGO).getValue();
    if (!codigo) {
      codigo = generarCodigoUnico(11);
      sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_CODIGO).setValue(codigo);
      Logger.log("  ‚úì C√≥digo generado: " + codigo);
    } else {
      Logger.log("  ‚úì C√≥digo existente: " + codigo);
    }
    
    // Proteger la celda de RUT
    protegerCeldaRut(sheet, row);
    
    // Generar el HTML del correo
    const htmlBody = generarHTMLCorreo(nombre, rut, codigo, asamblea);
    
    // Configurar asunto
    const asunto = 'Confirmaci√≥n de Asistencia - Asamblea Sindical ' + (asamblea || 'Sin especificar');
    
    // Texto plano como fallback
    const textoPlano = 'Estimado/a ' + nombre + ',\n\n' +
                       'Se ha registrado su asistencia a la asamblea sindical del mes de ' + asamblea + '.\n\n' +
                       'DATOS DE CONFIRMACI√ìN:\n' +
                       '- RUT: ' + rut + '\n' +
                       '- C√≥digo de Verificaci√≥n: ' + codigo + '\n' +
                       '- Asamblea: ' + asamblea + '\n\n' +
                       'Saludos,\n' +
                       'Atte. Dpto Comunicaciones SLIM n¬∞3';
    
    // Enviar correo
    MailApp.sendEmail({
      to: correo,
      subject: asunto,
      body: textoPlano,
      htmlBody: htmlBody
    });
    
    // Actualizar columna de validaci√≥n de correo
    sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_VALIDACION_CORREO)
      .setValue('Asistencia enviada al correo');
    
    Logger.log("  ‚úì Correo enviado exitosamente a: " + correo);
    
    return true;
    
  } catch (error) {
    Logger.log("  ‚úó Error al enviar correo: " + error.toString());
    
    // Registrar error en la hoja
    sheet.getRange(row, ORQUESTADOR_CONFIG.COLUMNA_VALIDACION_CORREO)
      .setValue('ERROR: ' + error.toString().substring(0, 50));
    
    return false;
  }
}

// ============================================================================
// FUNCI√ìN DE PRUEBA
// ============================================================================

/**
 * Funci√≥n para probar el orquestador manualmente
 * Simula la edici√≥n de una celda
 */
function probarOrquestador() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const fila = 4; // Cambiar al n√∫mero de fila que quieres probar
  
  Logger.log("üß™ INICIANDO PRUEBA DEL ORQUESTADOR");
  Logger.log("Fila a probar: " + fila);
  
  // Simular evento de edici√≥n
  const eventoSimulado = {
    source: SpreadsheetApp.getActiveSpreadsheet(),
    range: sheet.getRange(fila, 1),
    value: sheet.getRange(fila, 1).getValue(),
    oldValue: undefined // Simular nueva entrada
  };
  
  orquestadorMaestro(eventoSimulado);
  
  Logger.log("üß™ PRUEBA COMPLETADA");
}
